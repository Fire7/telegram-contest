"use strict";function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(t,e){var i=[],s=!0,a=!1,o=void 0;try{for(var n,r=t[Symbol.iterator]();!(s=(n=r.next()).done)&&(i.push(n.value),!e||i.length!==e);s=!0);}catch(t){a=!0,o=t}finally{try{s||null==r.return||r.return()}finally{if(a)throw o}}return i}function _arrayWithHoles(t){if(Array.isArray(t))return t}function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _objectWithoutProperties(t,e){if(null==t)return{};var i,s,a=_objectWithoutPropertiesLoose(t,e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);for(s=0;s<o.length;s++)i=o[s],e.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(t,i)&&(a[i]=t[i])}return a}function _objectWithoutPropertiesLoose(t,e){if(null==t)return{};var i,s,a={},o=Object.keys(t);for(s=0;s<o.length;s++)i=o[s],e.indexOf(i)>=0||(a[i]=t[i]);return a}function _possibleConstructorReturn(t,e){return!e||"object"!==_typeof(e)&&"function"!=typeof e?_assertThisInitialized(t):e}function _assertThisInitialized(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function _get(t,e,i){return(_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,i){var s=_superPropBase(t,e);if(s){var a=Object.getOwnPropertyDescriptor(s,e);return a.get?a.get.call(i):a.value}})(t,e,i||t)}function _superPropBase(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=_getPrototypeOf(t)););return t}function _getPrototypeOf(t){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&_setPrototypeOf(t,e)}function _setPrototypeOf(t,e){return(_setPrototypeOf=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function _instanceof(t,e){return null!=e&&"undefined"!=typeof Symbol&&e[Symbol.hasInstance]?e[Symbol.hasInstance](t):t instanceof e}function _classCallCheck(t,e){if(!_instanceof(t,e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}function _createClass(t,e,i){return e&&_defineProperties(t.prototype,e),i&&_defineProperties(t,i),t}function _defineProperty(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}var webGLUtils={createShader:function(t,e,i){var s=t.createShader(e);if(t.shaderSource(s,i),t.compileShader(s),t.getShaderParameter(s,t.COMPILE_STATUS))return s;console.log(t.getShaderInfoLog(s)),t.deleteShader(s)},createProgram:function(t,e,i){var s=t.createProgram();if(t.attachShader(s,e),t.attachShader(s,i),t.linkProgram(s),t.getProgramParameter(s,t.LINK_STATUS))return s;console.log(t.getProgramInfoLog(s)),t.deleteProgram(s)}};function loadFromSrc(t){var e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return fetch(t).then(function(t){return e?t.json():t.text()})}function hexToRgb(t){var e=parseInt(t.replace("#",""),16);return[e>>16&255,e>>8&255,255&e]}function convertValueToTextureData(t){if(1===t)return{r:255,g:255,b:255};var e=Math.round(16646655*t);return{r:e/65280>>0,g:e%65280/255>>0,b:e%255}}function writeValueToBuffer(t,e,i){i*=3;var s=convertValueToTextureData(e),a=s.r,o=s.g,n=s.b;t[i]=a,t[i+1]=o,t[i+2]=n}var LOG=!1,t0=0,t1=0,Chart=function(){function t(e,i,s){var a=this;_classCallCheck(this,t),_defineProperty(this,"handleColumnSelectorChange",function(t){for(var e,i,s=t.target.dataset.label,o=0,n=0;n<a.data.columns.length;n++)i=a.data.columns[n],o+=Number(i.active),i.label===s&&(e=i);if(e){var r=!e.active;!r&&o<2&&(r=!0),e.active=r,t.target.checked=r}}),this.data=i,this.rootEl=e,e.innerHTML=this.rootHTML();var o=window.devicePixelRatio,n=e.querySelector("[data-selector=chart]"),r=e.querySelector("[data-selector=chartValues]"),h=e.querySelector(".popup"),l=e.querySelector("[data-selector=chartControls]");this.columnSelector=e.querySelector(".column-selector"),this.plot=new Plot(n,r,{DPI:o,lineThickness:2,lineSmooth:1===o?.3:.85*o,popupEl:h,font:"".concat(14*o,"px Arial")}),this.controlPlot=new ControlPlot(l,null,{lineSmooth:.425*o}),this.setTheme(s),this.init(),this.renderBind=this.render.bind(this),requestAnimationFrame(this.renderBind)}return _createClass(t,[{key:"init",value:function(){this.plot.setChartData(this.data),this.controlPlot.setChartData(this.data),this.plot.setPosition(.75,1),this.controlPlot.setSelection(.75,1),this.columnSelector.addEventListener("change",this.handleColumnSelectorChange)}},{key:"setTheme",value:function(t){this.plot.setTheme(t),this.controlPlot.setTheme(t)}},{key:"resize",value:function(){this.plot.resize(),this.controlPlot.resize()}},{key:"rootHTML",value:function(){return'\n      <div>\n        <div class="chart-holder">\n          <canvas data-selector="chart"></canvas>\n          <canvas class="chart-values" data-selector="chartValues"></canvas> \n          <div class="popup"></div>\n        </div>\n        <div class="chart-controls-holder">\n            <canvas data-selector="chartControls"></canvas>\n        </div>\n        <div class="column-selector">'.concat(this.columnSelectorHTML(),"</div>\n      </div>\n    ")}},{key:"columnSelectorHTML",value:function(){return this.data.columns.map(function(t){var e=t.name,i=t.label,s=t.color;return'\n      <div>\n        <label>\n        <input type="checkbox" data-label="'.concat(i,'" checked />\n        <span class="checkbox-icon" style="color: ').concat(s,';"></span>\n        <span class="text">').concat(e,"</span>\n        </label>\n      </div>\n    ")}).join("")}},{key:"render",value:function(t){var e=t0=performance.now();this.plot.setPosition(this.controlPlot.left,this.controlPlot.right),this.plot.render(t),t1=performance.now(),LOG&&console.log(this.data.id+" main chart render:",t1-t0),t0=performance.now(),this.controlPlot.render(t),t1=performance.now(),LOG&&console.log(this.data.id+"control chart render",t1-t0),LOG&&console.error(this.data.id+"TOTAL",t1-e),requestAnimationFrame(this.renderBind)}}]),t}(),Plot=function(){function t(e,i,s){var a=this;_classCallCheck(this,t),_defineProperty(this,"handleMouseMove",function(t){a.mousePos=[t.pageX-a.canvasPos.left,t.pageY-a.canvasPos.top]}),_defineProperty(this,"handleMouseOut",function(){a.mousePos=[-100,-100]}),this.canvasPos=e.getBoundingClientRect(),this.options=Object.assign({},t.DEFAULT_OPTIONS,s),this.chartWidth=this.canvasPos.width-2*this.options.padding,this.chartOffset=this.options.padding/this.chartWidth,this.DPI=this.options.DPI,this.popupEl=this.options.popupEl,e.width=this.canvasPos.width*this.DPI,e.height=this.canvasPos.height*this.DPI;var o=e.getContext("webgl",{alpha:!1});if(o){var n=webGLUtils.createShader(o,o.VERTEX_SHADER,t.VERTEX_SHADER_SRC),r=webGLUtils.createShader(o,o.FRAGMENT_SHADER,t.FRAGMENT_SHADER_SRC),h=webGLUtils.createProgram(o,n,r);o.viewport(0,0,o.canvas.width,o.canvas.height),o.useProgram(h),this.program=h,this.buffer=o.createBuffer(),this.dataTexture=o.createTexture(),this.dataTextureUnit=0,o.bindTexture(o.TEXTURE_2D,this.dataTexture),o.activeTexture(o.TEXTURE0+this.dataTextureUnit);var l=new Uint8Array(t.DATA_TEXTURE_SIZE*t.DATA_TEXTURE_SIZE*3);o.texImage2D(o.TEXTURE_2D,t.DATA_TEXTURE_LEVEL,o.RGB,t.DATA_TEXTURE_SIZE,t.DATA_TEXTURE_SIZE,0,o.RGB,o.UNSIGNED_BYTE,l),o.generateMipmap(o.TEXTURE_2D),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,o.NEAREST),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,o.NEAREST),this.attributes={position:o.getAttribLocation(h,"a_position")},this.uniforms={mouse:o.getUniformLocation(h,"u_mouse"),dataTexture:o.getUniformLocation(h,"u_texture"),resolution:o.getUniformLocation(h,"u_resolution"),lineColor:o.getUniformLocation(h,"u_line_color"),lineThickness:o.getUniformLocation(h,"u_line_thickness"),lineSmooth:o.getUniformLocation(h,"u_line_smooth"),lineOpacity:o.getUniformLocation(h,"u_line_opacity"),yScale:o.getUniformLocation(h,"u_y_scale"),xStep:o.getUniformLocation(h,"u_x_step"),xOffset:o.getUniformLocation(h,"u_x_offset"),xPadding:o.getUniformLocation(h,"u_x_padding"),totalItems:o.getUniformLocation(h,"u_total_items"),scaleDraw:o.getUniformLocation(h,"u_scale_draw"),scaleOpacity:o.getUniformLocation(h,"u_scale_opacity"),scaleColor:o.getUniformLocation(h,"u_scale_color"),scaleThickness:o.getUniformLocation(h,"u_scale_thickness"),scaleCount:o.getUniformLocation(h,"u_scale_count"),scaleOffsetX:o.getUniformLocation(h,"u_scale_offset_x"),scaleStep:o.getUniformLocation(h,"u_scale_step"),bgColor:o.getUniformLocation(h,"u_bg_color"),mouseLineColor:o.getUniformLocation(h,"u_mouseline_color"),selectedCircleRadius:o.getUniformLocation(h,"u_selected_circle_radius")},this.gl=o,this.positionLeft=0,this.positionRight=1,this.animationsCount=0,this.animation=!1,this.isPositiveAnimation=!1,this.targetMaxValue=0,this.startAnimation=0,this.animationPosition=0,this.dMaxvalue=0,this.maxValue=0,this.activeColumns={},this.animatedColumns={},this.diff=0,this.scale=1,this.xOffset=0,this.totalItemsInFrame=0,this.step=1,this.bgColor=[0,0,0],this.drawDateItems={},this.drawDateItemsAnimations={},this.renderState={},this.init(this.options),i&&this.initValues(i,s.font)}else alert("WebGl is not supported by your browser")}return _createClass(t,[{key:"init",value:function(t){this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.uniform1f(this.uniforms.xPadding,t.padding*this.DPI),this.gl.uniform1f(this.uniforms.lineThickness,t.lineThickness*this.DPI),this.gl.uniform1f(this.uniforms.lineSmooth,t.lineSmooth),this.gl.uniform1f(this.uniforms.lineOpacity,1),this.gl.uniform2fv(this.uniforms.scaleThickness,[1*this.DPI,1*this.DPI]),this.gl.uniform2fv(this.uniforms.scaleCount,[t.scaleCount,t.scaleCount]),this.gl.uniform2fv(this.uniforms.scaleOffsetX,[t.scaleOffsetX*this.DPI,t.scaleOffsetX*this.DPI]),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),this.gl.STATIC_DRAW),this.gl.enableVertexAttribArray(this.attributes.position),this.gl.vertexAttribPointer(this.attributes.position,2,this.gl.FLOAT,!1,0,0),this.gl.uniform1f(this.uniforms.yScale,1),this.gl.uniform1f(this.uniforms.xOffset,0),this.gl.uniform1f(this.uniforms.selectedCircleRadius,t.selectedCircleRadius*this.DPI),this.scaleMax=[0,0],this.scaleDraw=[0,0],this.scaleStep=[1,1],this.scaleOpacity=[1,1],this.processScales(),this.mousePos=[-1,-1]}},{key:"initValues",value:function(t,e){var i=t.getBoundingClientRect();t.width=i.width*this.DPI,t.height=i.height*this.DPI,this.ctx=t.getContext("2d"),this.ctx.font=e,this.dateBasis=0,this.leftItem=0,this.rightItem=0,this.startItem=0,this.initInteractive(t)}},{key:"initInteractive",value:function(t){t.addEventListener("mousemove",this.handleMouseMove),t.addEventListener("mouseout",this.handleMouseOut)}},{key:"setTheme",value:function(t){var e=t.bgColor,i=t.scaleColor,s=t.textColor,a=t.mouseLineColor;this.gl.uniform3fv(this.uniforms.bgColor,e),this.gl.uniform3fv(this.uniforms.scaleColor,i.concat(i)),this.gl.uniform3fv(this.uniforms.mouseLineColor,a),this.bgColor=[e[0]/255,e[1]/255,e[2]/255],this.textColor=s,this.ctx&&(this.ctx.fillStyle=s),this.animationsCount++}},{key:"setChartData",value:function(t){this.chartData=t,this.activeColumns=t.columns.reduce(function(t,e){var i=e.label,s=e.active;return t[i]=s,t},{}),this.gl.uniform1f(this.uniforms.xStep,t.step),this.gl.uniform1f(this.uniforms.totalItems,t.length),this.firstRender=!0}},{key:"setPosition",value:function(e,i){var s=i-e;if(this.xOffset=e/s,this.gl.uniform1f(this.uniforms.xOffset,this.xOffset),s!==this.diff){this.diff=s,this.scale=1/s,this.step=this.scale*this.chartData.step,this.totalItemsInFrame=1/this.step,this.gl.uniform1f(this.uniforms.xStep,this.step);var a=this.totalItemsInFrame/(this.canvasPos.width/(8*t.DATE_WIDTH))>>0;if(a%2&&a--,this.dateBasis){if(this.dateBasis!==a){var o=a>this.dateBasis;(o?a/this.dateBasis>=2:this.dateBasis/a>=2)&&(o?this.dateBasis*=2:this.dateBasis/=2,this.dateBasis=Math.ceil(this.dateBasis),this.dateBasisChange=!0,this.leftItem&&e===this.positionLeft?this.startItem=this.leftItem%this.dateBasis:this.rightItem&&i===this.positionRight?this.startItem=this.rightItem%this.dateBasis:this.startItem=0)}}else this.dateBasis=a}this.positionLeft=e,this.positionRight=i}},{key:"resize",value:function(){this.canvasPos=this.gl.canvas.getBoundingClientRect(),this.gl.canvas.width=this.canvasPos.width*this.DPI,this.gl.viewport(0,0,this.gl.canvas.width,this.gl.canvas.height),this.chartWidth=this.canvasPos.width-2*this.options.padding,this.chartOffset=this.options.padding/this.chartWidth,this.animationsCount++,this.ctx&&(this.ctx.canvas.width=this.canvasPos.width*this.DPI,this.ctx.font=this.options.font,this.ctx.fillStyle=this.textColor,this.dateBasis=this.totalItemsInFrame/(this.canvasPos.width/(8*t.DATE_WIDTH))>>0,this.dateBasis%2&&this.dateBasis--)}},{key:"getLeftItem",value:function(){return this.totalItemsInFrame*this.xOffset-this.chartOffset/this.step}},{key:"getRightItem",value:function(){return this.getLeftItem()+this.totalItemsInFrame+2*this.chartOffset/this.step}},{key:"getMaxValue",value:function(t){var e,i;if(t<1e3)e=t/this.options.scaleCount+.3>>0,e+=3,t<100&&(e-=2),i=e*this.options.scaleCount;else{var s=t.toString().length;i=((t/(e=this.options.scaleCount*Math.pow(10,s-2))+.3>>0)+1)*e}return i}},{key:"formatValue",value:function(t){if(t>=1e6){var e=t/1e6,i=e.toFixed(2),s="0"!==i[i.length-2],a="0"!==i[i.length-1];return e.toFixed(a?2:s?1:0)+"m"}return t>1e4?(t/1e3>>0)+"k":t}},{key:"processColumn",value:function(e,i,s,a){var o=this.gl;o.uniform3fv(this.uniforms.lineColor,e.colorRGB),o.texImage2D(o.TEXTURE_2D,t.DATA_TEXTURE_LEVEL,o.RGB,t.DATA_TEXTURE_SIZE,t.DATA_TEXTURE_SIZE,0,o.RGB,o.UNSIGNED_BYTE,e.normalBuffer),o.uniform1i(this.uniforms.dataTexture,this.dataTextureUnit),o.uniform1f(this.uniforms.yScale,e.max/s),i>0&&o.uniform2fv(this.uniforms.scaleDraw,[0,0]),o.uniform1f(this.uniforms.lineOpacity,1);var n=this.animatedColumns[e.label];if(n){var r=(a-n.start)/200;r>=1?(delete this.animatedColumns[e.label],o.uniform1f(this.uniforms.lineOpacity,e.active?1:0)):(this.animationsCount++,o.uniform1f(this.uniforms.lineOpacity,e.active?r:1-r))}}},{key:"getMaxValueInPosition",value:function(t){for(var e=Math.max(0,Math.ceil(this.getLeftItem())),i=Math.min(t.values.length-1,this.getRightItem()>>0),s=0;e<=i;e++)s=Math.max(t.values[e],s);return this.getMaxValue(s)}},{key:"processScales",value:function(){var t=this.gl;t.uniform2fv(this.uniforms.scaleDraw,this.scaleDraw),t.uniform2fv(this.uniforms.scaleStep,this.scaleStep),t.uniform2fv(this.uniforms.scaleOpacity,this.scaleOpacity)}},{key:"popupHTML",value:function(e){var i=this;return"\n      <div class='date'>".concat(t.DATE_FORMAT.format(this.chartData.timestamps[e]),"</div>\n      <div class='values'>\n        ").concat(this.chartData.columns.map(function(t){return t.active?"\n            <div style='color:".concat(t.color,";'>\n              <div class='value'>").concat(i.formatValue(t.values[e]),"</div>\n              <div class='name'>").concat(t.name,"</div>\n            </div>\n          "):""}).join(""),"\n      </div>\n      ")}},{key:"drawScaleValues",value:function(){var t=this;this.scaleDraw.forEach(function(e,i){if(e){var s=t.scaleMax[i],a=6*t.scaleStep[i],o=t.scaleOpacity[i],n=s/6,r=a/6;t.ctx.globalAlpha=o;for(var h=6;h--;)t.ctx.fillText(t.formatValue(h*n),20*t.DPI,t.gl.canvas.height-h*r-5)}})}},{key:"drawDates",value:function(e){var i=this;this.ctx.globalAlpha=1;var s,a,o=!0,n={},r=Math.round(Math.max(this.startItem,this.getLeftItem()-this.totalItemsInFrame/2));for(r-=r%this.dateBasis,this.startItem&&(r-=r%this.startItem);r<this.chartData.length;r+=this.dateBasis)if(!((a=this.getItemPosition(r)*this.chartWidth)<-this.canvasPos.width/2)){if(a>this.canvasPos.width)break;o&&(this.leftItem=r,o=!1),delete this.drawDateItemsAnimations[r],this.drawDateItems[r]?((s=Math.min(1,(e-this.drawDateItems[r])/400))<1&&this.animationsCount++,n[r]=this.drawDateItems[r],delete this.drawDateItems[r]):(n[r]=this.dateBasisChange?e:1,s=this.dateBasisChange?0:1),this.ctx.globalAlpha=s,a-=t.DATE_WIDTH,this.rightItem=r,this.ctx.fillText(t.TIME_FORMAT.format(this.chartData.timestamps[r]),a*this.DPI,this.ctx.canvas.height-10)}this.dateBasisChange=!1,Object.keys(this.drawDateItemsAnimations).forEach(function(s){var a=Math.max(0,e-i.drawDateItemsAnimations[s])/400;if(a>=1)delete i.drawDateItemsAnimations[s];else{i.animationsCount++;var o=i.getItemPosition(s)*i.chartWidth-t.DATE_WIDTH;i.ctx.globalAlpha=1-a,i.ctx.fillText(t.TIME_FORMAT.format(i.chartData.timestamps[s]),o*i.DPI,i.ctx.canvas.height-10)}}),Object.keys(this.drawDateItems).forEach(function(s){if(!i.drawDateItemsAnimations[s]){i.drawDateItemsAnimations[s]=e;var a=i.getItemPosition(s)*i.chartWidth-t.DATE_WIDTH;i.ctx.fillText(t.TIME_FORMAT.format(i.chartData.timestamps[s]),a*i.DPI,i.ctx.canvas.height-10)}}),this.drawDateItems=n}},{key:"prepareColumns",value:function(t){for(var e,i=0;i<this.chartData.columns.length;i++)(e=this.chartData.columns[i]).active!==this.activeColumns[e.label]&&(this.activeColumns[e.label]=e.active,this.animatedColumns[e.label]={start:t},this.animationsCount++)}},{key:"storeRenderState",value:function(){this.renderState={positionLeft:this.positionLeft,positionRight:this.positionRight,mouseX:this.mousePos[0]}}},{key:"shouldRender",value:function(){return!this.maxValue||this.animationsCount||this.positionLeft!==this.renderState.positionLeft||this.positionRight!==this.renderState.positionRight||this.mousePos[0]!==this.renderState.mouseX}},{key:"render",value:function(t){var e=this;if(this.prepareColumns(t),this.shouldRender()){this.animationsCount=0;var i,s,a,o=[],n=0;for(i=0;i<this.chartData.columns.length;i++)s=this.chartData.columns[i],(this.animatedColumns[s.label]||s.active)&&o.push(s),s.active&&(n=(a=this.getMaxValueInPosition(s))>n?a:n);if(o.length){this.currMaxValue!==n&&n!==this.targetMaxValue&&(this.maxValue?(this.animation=!0,this.targetMaxValue=n,this.startAnimation=t,this.startMaxValue=this.currMaxValue,this.dMaxvalue=this.targetMaxValue-this.currMaxValue,this.isPositiveAnimation=this.targetMaxValue>this.startMaxValue,this.scaleMax=[this.maxValue,this.targetMaxValue]):this.maxValue=n);var r=this.gl,h=r.canvas.height/this.options.scaleCount;if(this.animation)this.animationPosition=(t-this.startAnimation)/this.options.animationTime,this.currMaxValue=this.startMaxValue+this.animationPosition*this.dMaxvalue,(this.isPositiveAnimation?this.currMaxValue>this.targetMaxValue:this.currMaxValue<this.targetMaxValue)?(this.animation=!1,this.maxValue=this.targetMaxValue):(this.animationsCount++,this.scaleDraw=[1,1],this.scaleStep=[this.isPositiveAnimation?h*(1-this.animationPosition):h*(1+this.animationPosition),this.isPositiveAnimation?h*(1-this.animationPosition+1):h*this.animationPosition],this.scaleOpacity=[1-this.animationPosition,this.animationPosition]);for(this.animation||(this.currMaxValue=this.maxValue,this.scaleMax=[this.maxValue,0],this.scaleOpacity=[1,1],this.scaleDraw=[1,0],this.scaleStep=[h,h]),r.uniform2fv(this.uniforms.mouse,this.mousePos.map(function(t){return t*e.DPI})),r.uniform2fv(this.uniforms.resolution,[r.canvas.width,r.canvas.height]),r.clearColor(this.bgColor[0],this.bgColor[1],this.bgColor[2],1),r.clear(r.COLOR_BUFFER_BIT),this.processScales(),i=0;i<o.length;i++)this.processColumn(o[i],i,this.currMaxValue,t),this.draw();this.renderValues(t),this.renderPopup(),this.storeRenderState(),this.firstRender=!1}else this.maxValue=0}}},{key:"renderValues",value:function(t){this.ctx&&(this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.drawScaleValues(),this.drawDates(t))}},{key:"draw",value:function(){this.gl.drawArrays(this.gl.TRIANGLES,0,6)}},{key:"getItemPosition",value:function(t){return t*this.step-this.xOffset+this.chartOffset}},{key:"renderPopup",value:function(){var t=this.mousePos[0];if(t<0)return this.popupEl.innerHTML="",this.popupEl.style.transform="translateX(-200%)",void(this.valueIndex=-1);var e=t/this.chartWidth-this.chartOffset,i=Math.round(this.totalItemsInFrame*this.xOffset+e/this.step),s=this.getItemPosition(i)*this.chartWidth;if(i>=this.chartData.length||i<0||s<0||s>this.canvasPos.width)return this.popupEl.innerHTML="",this.popupEl.style.transform="translateX(-200%)",void(this.valueIndex=-1);if(i!==this.valueIndex){this.popupEl.style.display="block",this.popupEl.innerHTML=this.popupHTML(i),this.valueIndex=i;var a=this.popupEl.getBoundingClientRect(),o=s,n=this.chartData.columns.reduce(function(t,e){return e.active?t>e.values[i]?t:e.values[i]:t},0)/this.maxValue;a.width+s>this.canvasPos.width?o=s-a.width+20:(o-30<0||n>.7)&&(o=s+30+10),this.popupEl.style.transform="translateX("+o+"px)"}}}]),t}();_defineProperty(Plot,"DATA_TEXTURE_SIZE",32),_defineProperty(Plot,"DATA_TEXTURE_LEVEL",0),_defineProperty(Plot,"VERTEX_SHADER_SRC",""),_defineProperty(Plot,"FRAGMENT_SHADER_SRC",""),_defineProperty(Plot,"TIME_FORMAT",new Intl.DateTimeFormat("en-us",{day:"numeric",month:"short"})),_defineProperty(Plot,"DATE_FORMAT",new Intl.DateTimeFormat("en-us",{weekday:"short",day:"numeric",month:"short"})),_defineProperty(Plot,"DATE_WIDTH",20),_defineProperty(Plot,"DEFAULT_OPTIONS",{DPI:window.devicePixelRatio,animationTime:400,popupEl:null,lineThickness:1,lineSmooth:1,scaleThickness:1,scaleCount:6,scaleOffsetX:20,selectedCircleRadius:5,font:"",padding:20});var ControlPlot=function(t){function e(){var t,i;_classCallCheck(this,e);for(var s=arguments.length,a=new Array(s),o=0;o<s;o++)a[o]=arguments[o];return _defineProperty(_assertThisInitialized(i=_possibleConstructorReturn(this,(t=_getPrototypeOf(e)).call.apply(t,[this].concat(a)))),"handleMouseDown",function(t){var e=t.pageX-i.canvasPos.left,s=i.left*i.canvasPos.width,a=i.right*i.canvasPos.width;Math.abs(s-e)<10&&(i.drag="left"),Math.abs(a-e)<10&&(i.drag="right"),!i.drag&&e>s&&e<a&&(i.drag="center"),i.drag&&(i.startDragPos=t.pageX,i.startLeft=i.left,i.startRight=i.right)}),_defineProperty(_assertThisInitialized(i),"handleDocMouseMove",function(t){if(i.drag){var s=(t.pageX-i.startDragPos)/i.canvasPos.width,a=i.startLeft,o=i.startRight;switch(i.drag){case"left":a=Math.max(0,i.startLeft+s);break;case"right":o=Math.min(1,i.startRight+s);break;case"center":a=Math.max(0,i.startLeft+s),o=Math.min(1,i.startRight+s)}o-a>=e.MIN_DIFF&&(i.left=a,i.right=o)}}),_defineProperty(_assertThisInitialized(i),"handleDocMouseUp",function(){i.drag=""}),i.initInteractive(),i}return _inherits(e,Plot),_createClass(e,[{key:"init",value:function(t){_get(_getPrototypeOf(e.prototype),"init",this).call(this,t);var i=this.gl;this.uniforms=Object.assign(this.uniforms,{rectTopThickness:i.getUniformLocation(this.program,"u_rect_top_thickness"),rectLeftThickness:i.getUniformLocation(this.program,"u_rect_left_thickness"),drawRect:i.getUniformLocation(this.program,"u_draw_rect"),rect:i.getUniformLocation(this.program,"u_rect"),rectColor:i.getUniformLocation(this.program,"u_rect_color"),substrateColor:i.getUniformLocation(this.program,"u_substrate_color"),fill:i.getUniformLocation(this.program,"u_fill")}),this.options=Object.assign(this.options,t,e.DEFAULT_OPTIONS),this.gl.uniform1f(this.uniforms.drawRect,1),this.gl.uniform1f(this.uniforms.rectTopThickness,t.rectTopThickness*this.DPI),this.gl.uniform1f(this.uniforms.rectLeftThickness,t.rectLeftThickness*this.DPI),this.gl.uniform1f(this.uniforms.xPadding,0)}},{key:"initInteractive",value:function(){this.left=0,this.right=1,this.drag="",this.startDragPos=0,this.startLeft=0,this.startRight=1,this.gl.canvas.addEventListener("mousedown",this.handleMouseDown),document.addEventListener("mousemove",this.handleDocMouseMove),document.addEventListener("mouseup",this.handleDocMouseUp)}},{key:"setTheme",value:function(t){var i=t.rectColor,s=t.substrateColor,a=_objectWithoutProperties(t,["rectColor","substrateColor"]);_get(_getPrototypeOf(e.prototype),"setTheme",this).call(this,{...a}),this.gl.uniform3fv(this.uniforms.rectColor,i),this.gl.uniform3fv(this.uniforms.substrateColor,s)}},{key:"setSelection",value:function(t,e){this.left=t,this.right=e}},{key:"getMaxValueInPosition",value:function(t){return this.getMaxValue(t.max)}},{key:"processColumn",value:function(t,i){for(var s,a=arguments.length,o=new Array(a>2?a-2:0),n=2;n<a;n++)o[n-2]=arguments[n];(s=_get(_getPrototypeOf(e.prototype),"processColumn",this)).call.apply(s,[this,t,i].concat(o)),this.gl.uniform2fv(this.uniforms.scaleDraw,[0,0]),this.gl.uniform1f(this.uniforms.fill,Number(!i))}},{key:"storeRenderState",value:function(){this.renderState={left:this.left,right:this.right}}},{key:"shouldRender",value:function(){return!this.maxValue||this.animationsCount||this.left!==this.renderState.left||this.right!==this.renderState.right}},{key:"render",value:function(){var t;this.gl.uniform2fv(this.uniforms.rect,[this.left,this.right]);for(var i=arguments.length,s=new Array(i),a=0;a<i;a++)s[a]=arguments[a];(t=_get(_getPrototypeOf(e.prototype),"render",this)).call.apply(t,[this].concat(s))}},{key:"renderValues",value:function(){}},{key:"renderPopup",value:function(){}}]),e}();_defineProperty(ControlPlot,"MIN_DIFF",.05),_defineProperty(ControlPlot,"DEFAULT_OPTIONS",{rectTopThickness:2,rectLeftThickness:7,rectColor:[],substrateColor:[]});var CHART_DATA_SRC="chart_data.json",VERTEX_SHADER_SRC="vertex.glsl",FRAGMENT_SHADER_SRC="fragment.glsl",DATA_TEXTURE_SIZE=32,LIGHT_THEME={rectColor:[222,234,242],bgColor:[255,255,255],substrateColor:[245,249,251],scaleColor:[204,204,204],mouseLineColor:[224,230,234],textColor:"#A8B1B7"},DARK_THEME={rectColor:[66,86,105],bgColor:[37,47,61],substrateColor:[32,42,55],scaleColor:[42,53,67],mouseLineColor:[61,74,89],textColor:"#566776"},bodyElem=document.getElementsByTagName("body")[0],mainElem=document.getElementsByTagName("main")[0],nightMode=!1;function parseChartData(t){return t.map(function(t,e){var i={id:"chart_".concat(e),columns:[],timestamps:[],step:0,length:0};return t.columns.forEach(function(e){var s=e[0],a=e.slice(1);switch(t.types[s]){case"x":i.timestamps=a,i.length=i.timestamps.length,i.step=1/(i.length-1);break;case"line":var o={active:!0,label:s,name:t.names[s],color:t.colors[s],colorRGB:hexToRgb(t.colors[s]),values:a},n=Math.max.apply(null,a),r=a.map(function(t){return t/n}),h=new Uint8Array(DATA_TEXTURE_SIZE*DATA_TEXTURE_SIZE*3);r.forEach(function(t,e){writeValueToBuffer(h,t,e)}),o.max=n,o.normalData=r,o.normalBuffer=h,i.columns.push(o)}}),i})}var resizeTimeout=0,width=mainElem.clientWidth,charts=[];function doResize(){console.log("doResize",width!==mainElem.clientWidth),width!==mainElem.clientWidth&&(index=0,width=mainElem.clientWidth,requestAnimationFrame(resizeCharts))}var index=0;function resizeCharts(){charts[index]&&(charts[index++].resize(mainElem.clientWidth),requestAnimationFrame(resizeCharts))}async function main(){var t=_slicedToArray(await Promise.all([loadFromSrc(VERTEX_SHADER_SRC),loadFromSrc(FRAGMENT_SHADER_SRC),loadFromSrc(CHART_DATA_SRC,!0)]),3),e=t[0],i=t[1],s=parseChartData(t[2]);Plot.DATA_TEXTURE_SIZE=DATA_TEXTURE_SIZE,Plot.VERTEX_SHADER_SRC=e,Plot.FRAGMENT_SHADER_SRC=i,charts=s.map(function(t,e){return new Chart(document.getElementById("chart"+(e+1)),t,LIGHT_THEME)});var a=document.getElementById("switch_theme");a.addEventListener("click",function(){nightMode=!nightMode,a.innerText=nightMode?"Switch to Day Mode":"Switch to Night Mode",bodyElem.classList.toggle("dark-theme",nightMode);var t=nightMode?DARK_THEME:LIGHT_THEME;charts.forEach(function(e){return e.setTheme(t)})}),window.addEventListener("resize",function(){clearTimeout(resizeTimeout),resizeTimeout=setTimeout(doResize,400)})}main();
